name: Labubu Watcher

on:
  schedule:
    - cron: '*/10 * * * *'  # æ¯10åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]  # æ¨é€åˆ°ä¸»åˆ†æ”¯æ—¶è¿è¡Œï¼ˆç”¨äºæµ‹è¯•ï¼‰
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'docs/**'

env:
  NODE_ENV: production
  USE_PROXY: true
  PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: false
  PUPPETEER_DOWNLOAD_HOST: 'https://npmmirror.com/mirrors/chromium'

jobs:
  run-labubu:
    runs-on: ubuntu-latest
    timeout-minutes: 20  # å‡å°‘è¶…æ—¶æ—¶é—´ï¼Œæ›´å¿«å‘ç°é—®é¢˜

    strategy:
      fail-fast: false  # å³ä½¿ä¸€ä¸ªä»»åŠ¡å¤±è´¥ï¼Œå…¶ä»–ä»»åŠ¡ç»§ç»­æ‰§è¡Œ

    env:
      BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
      CHAT_ID: ${{ secrets.CHAT_ID }}
      # ä»£ç†é…ç½® - æ”¯æŒå¤šä¸ªä»£ç†
      PROXY_1_IP: ${{ secrets.PROXY_1_IP }}
      PROXY_1_PORT: ${{ secrets.PROXY_1_PORT }}
      PROXY_1_USERNAME: ${{ secrets.PROXY_1_USERNAME }}
      PROXY_1_PASSWORD: ${{ secrets.PROXY_1_PASSWORD }}
      PROXY_2_IP: ${{ secrets.PROXY_2_IP }}
      PROXY_2_PORT: ${{ secrets.PROXY_2_PORT }}
      PROXY_2_USERNAME: ${{ secrets.PROXY_2_USERNAME }}
      PROXY_2_PASSWORD: ${{ secrets.PROXY_2_PASSWORD }}
      PROXY_3_IP: ${{ secrets.PROXY_3_IP }}
      PROXY_3_PORT: ${{ secrets.PROXY_3_PORT }}
      PROXY_3_USERNAME: ${{ secrets.PROXY_3_USERNAME }}
      PROXY_3_PASSWORD: ${{ secrets.PROXY_3_PASSWORD }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache Puppeteer
        uses: actions/cache@v4
        with:
          path: ~/.cache/puppeteer
          key: ${{ runner.os }}-puppeteer-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-puppeteer-

      - name: Cache security verification status
        uses: actions/cache@v4
        with:
          path: security-verification-status.json
          key: ${{ runner.os }}-security-status-${{ github.repository }}
          restore-keys: |
            ${{ runner.os }}-security-status-

      - name: Install dependencies
        run: |
          npm ci --include=dev

      - name: Install system dependencies for Puppeteer
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libnss3-dev \
            libatk-bridge2.0-dev \
            libdrm-dev \
            libxcomposite-dev \
            libxdamage-dev \
            libxrandr-dev \
            libgbm-dev \
            libxss-dev \
            libasound2-dev \
            libatspi2.0-dev \
            libgtk-3-dev

      - name: Verify environment
        run: |
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"
          echo "TypeScript version: $(npx tsc --version)"
          echo "Environment: $NODE_ENV"
          echo "Use proxy: $USE_PROXY"

      - name: Run configuration validation
        run: |
          npx ts-node -e "
            import { validateConfig } from './src/config';
            const result = validateConfig();
            if (!result.valid) {
              console.error('Configuration validation failed:', result.errors);
              process.exit(1);
            }
            console.log('Configuration validation passed');
          "

      - name: Run Labubu monitoring tasks (Fallback to Original)
        run: |
          # ä¸´æ—¶å›é€€åˆ°åŸç‰ˆæœ¬ï¼Œå› ä¸ºä¼˜åŒ–ç‰ˆæœ¬é‡åˆ°é—®é¢˜
          echo "ä½¿ç”¨åŸç‰ˆæœ¬ç›‘æ§ä»»åŠ¡ï¼ˆä¼˜åŒ–ç‰ˆæœ¬è°ƒè¯•ä¸­ï¼‰"
          npm start 2>&1 | tee monitoring.log
        timeout-minutes: 25  # åŸç‰ˆæœ¬è¶…æ—¶æ—¶é—´

      - name: Check for security verification
        if: always()  # æ€»æ˜¯æ£€æŸ¥ï¼Œæ— è®ºç›‘æ§ä»»åŠ¡æ˜¯å¦æˆåŠŸ
        continue-on-error: true  # ç¡®ä¿æ­¤æ­¥éª¤ä¸ä¼šå¯¼è‡´workflowå¤±è´¥
        run: |
          # ç»™è„šæœ¬æ‰§è¡Œæƒé™
          chmod +x scripts/check-security-verification.sh

          echo "å¼€å§‹æ£€æŸ¥å®‰å…¨éªŒè¯çŠ¶æ€..."

          # è¿è¡Œå®‰å…¨éªŒè¯æ£€æµ‹è„šæœ¬ï¼Œå¹¶ç¡®ä¿ä¸å½±å“workflowçŠ¶æ€
          set +e  # ä¸´æ—¶ç¦ç”¨é”™è¯¯é€€å‡º
          ./scripts/check-security-verification.sh
          VERIFICATION_EXIT_CODE=$?
          set -e  # é‡æ–°å¯ç”¨é”™è¯¯é€€å‡º

          echo "å®‰å…¨éªŒè¯æ£€æµ‹å®Œæˆï¼Œé€€å‡ºç : $VERIFICATION_EXIT_CODE"

          if [ $VERIFICATION_EXIT_CODE -eq 2 ]; then
            echo "âœ… æ£€æµ‹åˆ°å®‰å…¨éªŒè¯è¦æ±‚ï¼Œå·²å¤„ç†é€šçŸ¥é€»è¾‘"
            echo "ğŸ“ æ³¨æ„ï¼šè¿™ä¸æ˜¯é”™è¯¯ï¼Œåªæ˜¯éœ€è¦ç”¨æˆ·æ‰‹åŠ¨å¤„ç†éªŒè¯"
          elif [ $VERIFICATION_EXIT_CODE -eq 0 ]; then
            echo "âœ… æœªæ£€æµ‹åˆ°å®‰å…¨éªŒè¯è¦æ±‚"
          else
            echo "âš ï¸ å®‰å…¨éªŒè¯æ£€æµ‹è„šæœ¬æ‰§è¡Œå‡ºé”™ï¼Œä½†ä¸å½±å“workflowçŠ¶æ€"
          fi

          # ç¡®ä¿æ­¤æ­¥éª¤æ€»æ˜¯æˆåŠŸ
          exit 0

      - name: Upload monitoring logs
        if: always()  # æ€»æ˜¯ä¸Šä¼ æ—¥å¿—ï¼Œæ— è®ºæˆåŠŸæˆ–å¤±è´¥
        uses: actions/upload-artifact@v4
        with:
          name: monitoring-logs-${{ github.run_number }}
          path: |
            monitoring.log
            debug-*.png
            debug-*.html
            *.log
          retention-days: 7

      - name: Upload debug artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: debug-artifacts-${{ github.run_number }}
          path: |
            debug-*.png
            debug-*.html
            *.log
          retention-days: 7

      - name: Notify on failure
        if: failure()
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d text="ğŸš¨ GitHub Actions æ‰§è¡Œå¤±è´¥ï¼

          å·¥ä½œæµ: ${{ github.workflow }}
          è¿è¡Œç¼–å·: ${{ github.run_number }}
          æäº¤: ${{ github.sha }}
          æ—¶é—´: $(date)

          è¯·æ£€æŸ¥ GitHub Actions æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯ã€‚" \
            -d parse_mode="HTML"