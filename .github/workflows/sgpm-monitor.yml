name: SGPM (Singapore PopMart) Monitor

on:
  schedule:
    - cron: '*/5 * * * *'  # æ¯5åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]  # æ¨é€åˆ°ä¸»åˆ†æ”¯æ—¶è¿è¡Œï¼ˆç”¨äºæµ‹è¯•ï¼‰
    paths:
      - 'src/sgpm-main.ts'
      - 'src/sgpm-optimized-main.ts'  # æ·»åŠ ä¼˜åŒ–ç‰ˆæœ¬
      - 'src/config-sgpm.ts'
      - 'src/services/SgpmService.ts'
      - 'src/services/OptimizedSgpmService.ts'  # æ·»åŠ ä¼˜åŒ–ç‰ˆæœ¬
      - '.github/workflows/sgpm-monitor.yml'

env:
  NODE_ENV: production
  USE_PROXY: false  # SGPMä¸éœ€è¦ä»£ç†
  PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: false
  PUPPETEER_DOWNLOAD_HOST: 'https://npmmirror.com/mirrors/chromium'

jobs:
  sgpm-monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # SGPMç›‘æ§é€šå¸¸è¾ƒå¿«

    strategy:
      fail-fast: false  # å³ä½¿å¤±è´¥ä¹Ÿä¸å½±å“å…¶ä»–workflow

    env:
      # SGPMä¸“ç”¨çš„Telegramé…ç½®
      SGPM_BOT_TOKEN: ${{ secrets.SGPM_BOT_TOKEN }}
      SGPM_CHAT_ID: ${{ secrets.SGPM_CHAT_ID }}
      # è°ƒè¯•æ¨¡å¼
      DEBUG_MODE: ${{ vars.DEBUG_MODE || 'false' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # åªè·å–æœ€æ–°æäº¤ï¼ŒåŠ å¿«é€Ÿåº¦

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci --include=dev
          # å®‰è£…Puppeteerçš„Chromium
          npx puppeteer browsers install chrome

      - name: Verify SGPM environment
        run: |
          echo "âœ… Node: $(node --version), NPM: $(npm --version)"
          echo "ğŸ¤– Bot: ${SGPM_BOT_TOKEN:+âœ…}${SGPM_BOT_TOKEN:-âŒ}, Chat: ${SGPM_CHAT_ID:+âœ…}${SGPM_CHAT_ID:-âŒ}"

      - name: Check SGPM status
        run: |
          echo "ğŸ“‹ çŠ¶æ€æ–‡ä»¶: $([ -f 'sgpm-products-status.json' ] && echo 'âœ… å­˜åœ¨' || echo 'âŒ ä¸å­˜åœ¨')"

      - name: Run SGPM monitoring
        run: |
          echo "ğŸš€ å¯åŠ¨SGPMé«˜æ€§èƒ½ç›‘æ§..."
          node --expose-gc --max-old-space-size=1024 -r ts-node/register src/sgpm-optimized-main.ts 2>&1 | tee sgpm-monitoring.log
        timeout-minutes: 8  # è¿›ä¸€æ­¥ä¼˜åŒ–è¶…æ—¶æ—¶é—´

      - name: Check results
        if: always()
        run: |
          # ç®€åŒ–çš„ç»“æœæ£€æŸ¥
          STATUS_FILE=$([ -f "sgpm-products-status.json" ] && echo "âœ…" || echo "âŒ")
          LOG_LINES=$([ -f "sgpm-monitoring.log" ] && wc -l < sgpm-monitoring.log || echo "0")
          ERRORS=$([ -f "sgpm-monitoring.log" ] && grep -c -i "error\|fail" sgpm-monitoring.log 2>/dev/null || echo "0")
          SUCCESS=$([ -f "sgpm-monitoring.log" ] && grep -c -i "âœ…\|å®Œæˆ\|æˆåŠŸ" sgpm-monitoring.log 2>/dev/null || echo "0")

          echo "ğŸ“Š ç»“æœ: çŠ¶æ€æ–‡ä»¶${STATUS_FILE} | æ—¥å¿—${LOG_LINES}è¡Œ | é”™è¯¯${ERRORS} | æˆåŠŸ${SUCCESS}"

      - name: Upload logs
        if: failure()  # åªåœ¨å¤±è´¥æ—¶ä¸Šä¼ æ—¥å¿—
        uses: actions/upload-artifact@v4
        with:
          name: sgpm-logs-${{ github.run_number }}
          path: sgpm-monitoring.log
          retention-days: 3  # å‡å°‘ä¿ç•™æ—¶é—´

      - name: Notify failure
        if: failure()
        run: |
          # ç®€åŒ–çš„å¤±è´¥é€šçŸ¥
          if [ -n "$SGPM_BOT_TOKEN" ] && [ -n "$SGPM_CHAT_ID" ]; then
            curl -s -X POST "https://api.telegram.org/bot${SGPM_BOT_TOKEN}/sendMessage" \
              -d chat_id="${SGPM_CHAT_ID}" \
              -d text="ï¿½ SGPMç›‘æ§å¤±è´¥ #${{ github.run_number }} - ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
              > /dev/null 2>&1
          fi

      - name: Cleanup
        if: always()
        run: rm -f sgpm-monitoring.log
