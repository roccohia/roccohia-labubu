name: SGPM (Singapore PopMart) Monitor

on:
  schedule:
    - cron: '*/5 * * * *'  # æ¯5åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]  # æ¨é€åˆ°ä¸»åˆ†æ”¯æ—¶è¿è¡Œï¼ˆç”¨äºæµ‹è¯•ï¼‰
    paths:
      - 'src/simple-sgpm-main.ts'  # ç®€åŒ–ç‰ˆæœ¬ä¸»æ–‡ä»¶
      - 'src/services/SimpleSgpmService.ts'  # ç®€åŒ–ç‰ˆæœ¬æœåŠ¡
      - 'src/config-sgpm.ts'
      - '.github/workflows/sgpm-monitor.yml'

env:
  NODE_ENV: production
  USE_PROXY: false  # SGPMä¸éœ€è¦ä»£ç†
  PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: false
  PUPPETEER_DOWNLOAD_HOST: 'https://npmmirror.com/mirrors/chromium'

jobs:
  sgpm-monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # SGPMç›‘æ§é€šå¸¸è¾ƒå¿«

    strategy:
      fail-fast: false  # å³ä½¿å¤±è´¥ä¹Ÿä¸å½±å“å…¶ä»–workflow

    env:
      # SGPMä¸“ç”¨çš„Telegramé…ç½®
      SGPM_BOT_TOKEN: ${{ secrets.SGPM_BOT_TOKEN }}
      SGPM_CHAT_ID: ${{ secrets.SGPM_CHAT_ID }}
      # è°ƒè¯•æ¨¡å¼
      DEBUG_MODE: ${{ vars.DEBUG_MODE || 'false' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # åªè·å–æœ€æ–°æäº¤ï¼ŒåŠ å¿«é€Ÿåº¦

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci --include=dev
          # å®‰è£…Puppeteerçš„Chromium
          npx puppeteer browsers install chrome

      - name: Verify SGPM environment
        run: |
          echo "âœ… Node: $(node --version), NPM: $(npm --version)"
          echo "ğŸ¤– Bot: ${SGPM_BOT_TOKEN:+âœ…}${SGPM_BOT_TOKEN:-âŒ}, Chat: ${SGPM_CHAT_ID:+âœ…}${SGPM_CHAT_ID:-âŒ}"

      - name: Check SGPM status
        run: |
          echo "ğŸ“‹ çŠ¶æ€æ–‡ä»¶: $([ -f 'sgpm-products-status.json' ] && echo 'âœ… å­˜åœ¨' || echo 'âŒ ä¸å­˜åœ¨')"

      - name: Run SGPM monitoring (Simple Version)
        run: |
          echo "ğŸš€ å¯åŠ¨ç®€åŒ–SGPMç›‘æ§..."
          npx ts-node src/simple-sgpm-main.ts 2>&1 | tee sgpm-monitoring.log
        timeout-minutes: 8  # è¿›ä¸€æ­¥ä¼˜åŒ–è¶…æ—¶æ—¶é—´

      - name: Check results
        if: always()
        run: |
          # ç®€åŒ–çš„ç»“æœæ£€æŸ¥
          STATUS_FILE=$([ -f "sgpm-products-status.json" ] && echo "âœ…" || echo "âŒ")
          LOG_LINES=$([ -f "sgpm-monitoring.log" ] && wc -l < sgpm-monitoring.log || echo "0")
          ERRORS=$([ -f "sgpm-monitoring.log" ] && grep -c -i "error\|fail" sgpm-monitoring.log 2>/dev/null || echo "0")
          SUCCESS=$([ -f "sgpm-monitoring.log" ] && grep -c -i "âœ…\|å®Œæˆ\|æˆåŠŸ" sgpm-monitoring.log 2>/dev/null || echo "0")

          echo "ğŸ“Š ç»“æœ: çŠ¶æ€æ–‡ä»¶${STATUS_FILE} | æ—¥å¿—${LOG_LINES}è¡Œ | é”™è¯¯${ERRORS} | æˆåŠŸ${SUCCESS}"

      - name: ğŸ› è°ƒè¯•çª—å£ - é”™è¯¯åˆ†æ
        if: always()
        run: |
          echo "==================== ğŸ› è°ƒè¯•çª—å£å¼€å§‹ ===================="
          echo "ğŸ“… è¿è¡Œæ—¶é—´: $(date)"
          echo "ğŸ”¢ è¿è¡Œç¼–å·: ${{ github.run_number }}"
          echo "ğŸŒ ç¯å¢ƒä¿¡æ¯: GitHub Actions (ubuntu-latest)"
          echo ""

          # æ£€æŸ¥çŠ¶æ€æ–‡ä»¶
          if [ -f "sgpm-products-status.json" ]; then
            echo "ğŸ“‹ çŠ¶æ€æ–‡ä»¶: âœ… å­˜åœ¨"
            echo "ğŸ“„ çŠ¶æ€æ–‡ä»¶å¤§å°: $(wc -c < sgpm-products-status.json) bytes"
          else
            echo "ğŸ“‹ çŠ¶æ€æ–‡ä»¶: âŒ ä¸å­˜åœ¨"
          fi
          echo ""

          # åˆ†ææ—¥å¿—æ–‡ä»¶
          if [ -f "sgpm-monitoring.log" ]; then
            echo "ğŸ“Š æ—¥å¿—ç»Ÿè®¡:"
            echo "  - æ€»è¡Œæ•°: $(wc -l < sgpm-monitoring.log)"
            echo "  - é”™è¯¯æ•°: $(grep -c -i "error\|fail\|âŒ" sgpm-monitoring.log 2>/dev/null || echo "0")"
            echo "  - è­¦å‘Šæ•°: $(grep -c -i "warn\|âš ï¸" sgpm-monitoring.log 2>/dev/null || echo "0")"
            echo "  - æˆåŠŸæ•°: $(grep -c -i "âœ…\|å®Œæˆ\|æˆåŠŸ" sgpm-monitoring.log 2>/dev/null || echo "0")"
            echo ""

            # æ˜¾ç¤ºæœ€åçš„é”™è¯¯ä¿¡æ¯
            echo "ğŸ”´ æœ€è¿‘çš„é”™è¯¯ä¿¡æ¯:"
            echo "----------------------------------------"
            grep -i "error\|fail\|âŒ" sgpm-monitoring.log | tail -10 || echo "æ— é”™è¯¯ä¿¡æ¯"
            echo "----------------------------------------"
            echo ""

            # æ˜¾ç¤ºæœ€åçš„è­¦å‘Šä¿¡æ¯
            echo "ğŸŸ¡ æœ€è¿‘çš„è­¦å‘Šä¿¡æ¯:"
            echo "----------------------------------------"
            grep -i "warn\|âš ï¸" sgpm-monitoring.log | tail -5 || echo "æ— è­¦å‘Šä¿¡æ¯"
            echo "----------------------------------------"
            echo ""

            # æ˜¾ç¤ºæµè§ˆå™¨ç›¸å…³é”™è¯¯
            echo "ğŸŒ æµè§ˆå™¨ç›¸å…³é”™è¯¯:"
            echo "----------------------------------------"
            grep -i "browser\|puppeteer\|target\|session\|protocol" sgpm-monitoring.log | grep -i "error\|fail" | tail -5 || echo "æ— æµè§ˆå™¨é”™è¯¯"
            echo "----------------------------------------"
            echo ""

            # æ˜¾ç¤ºæœ€åå‡ è¡Œæ—¥å¿—
            echo "ğŸ“ æœ€å10è¡Œæ—¥å¿—:"
            echo "----------------------------------------"
            tail -10 sgpm-monitoring.log
            echo "----------------------------------------"
          else
            echo "ğŸ“Š æ—¥å¿—æ–‡ä»¶: âŒ ä¸å­˜åœ¨"
          fi

          echo ""
          echo "ğŸ’¡ å¤åˆ¶ä¸Šé¢çš„é”™è¯¯ä¿¡æ¯ç»™å¼€å‘è€…åˆ†æ"
          echo "==================== ğŸ› è°ƒè¯•çª—å£ç»“æŸ ===================="

      - name: ğŸ“‹ é”™è¯¯æ‘˜è¦ - å¿«é€Ÿå¤åˆ¶åŒºåŸŸ
        if: failure()
        run: |
          echo "==================== ğŸ“‹ é”™è¯¯æ‘˜è¦ (å¿«é€Ÿå¤åˆ¶) ===================="
          echo "ğŸš¨ è¿è¡Œå¤±è´¥ - å…³é”®é”™è¯¯ä¿¡æ¯:"
          echo ""

          if [ -f "sgpm-monitoring.log" ]; then
            # æå–å…³é”®é”™è¯¯ä¿¡æ¯
            echo "ğŸ”¥ è‡´å‘½é”™è¯¯:"
            grep -i "error.*:" sgpm-monitoring.log | tail -3 || echo "æ— è‡´å‘½é”™è¯¯"
            echo ""

            echo "âš ï¸ æµè§ˆå™¨é—®é¢˜:"
            grep -i "targetcloseerror\|protocol error\|session closed\|browser.*fail" sgpm-monitoring.log | tail -3 || echo "æ— æµè§ˆå™¨é—®é¢˜"
            echo ""

            echo "ğŸ”§ è¿æ¥é—®é¢˜:"
            grep -i "connection\|timeout\|abort\|refused" sgpm-monitoring.log | tail -3 || echo "æ— è¿æ¥é—®é¢˜"
            echo ""

            echo "ğŸ’¥ å¼‚å¸¸å †æ ˆ:"
            grep -A 2 -i "stack.*:" sgpm-monitoring.log | tail -6 || echo "æ— å¼‚å¸¸å †æ ˆ"
            echo ""
          fi

          echo "ğŸ“Š å¿«é€Ÿç»Ÿè®¡:"
          echo "- è¿è¡Œç¼–å·: ${{ github.run_number }}"
          echo "- æ—¶é—´: $(date)"
          echo "- é”™è¯¯æ•°: $([ -f "sgpm-monitoring.log" ] && grep -c -i "error" sgpm-monitoring.log || echo "0")"
          echo "- çŠ¶æ€æ–‡ä»¶: $([ -f "sgpm-products-status.json" ] && echo "å­˜åœ¨" || echo "ç¼ºå¤±")"
          echo ""
          echo "ğŸ”— å®Œæ•´æ—¥å¿—: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "==================== ğŸ“‹ é”™è¯¯æ‘˜è¦ç»“æŸ ===================="

      - name: Upload logs
        if: failure()  # åªåœ¨å¤±è´¥æ—¶ä¸Šä¼ æ—¥å¿—
        uses: actions/upload-artifact@v4
        with:
          name: sgpm-logs-${{ github.run_number }}
          path: sgpm-monitoring.log
          retention-days: 3  # å‡å°‘ä¿ç•™æ—¶é—´

      - name: Notify failure
        if: failure()
        run: |
          # ç®€åŒ–çš„å¤±è´¥é€šçŸ¥
          if [ -n "$SGPM_BOT_TOKEN" ] && [ -n "$SGPM_CHAT_ID" ]; then
            curl -s -X POST "https://api.telegram.org/bot${SGPM_BOT_TOKEN}/sendMessage" \
              -d chat_id="${SGPM_CHAT_ID}" \
              -d text="ï¿½ SGPMç›‘æ§å¤±è´¥ #${{ github.run_number }} - ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
              > /dev/null 2>&1
          fi

      - name: Cleanup
        if: always()
        run: rm -f sgpm-monitoring.log
